@page "/signup"
@using Blazor.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Npgsql

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject Blazor.Services.DbConfig DbConfig

<h3>Sign Up</h3>

<div class="signup-container">
    @if (!string.IsNullOrEmpty(Error))
    {
        <div class="error-message">@Error</div>
    }

    <input class="signup-input" @bind="Name" placeholder="Name" />
    <input class="signup-input" @bind="Email" placeholder="Email" type="email" />
    <input class="signup-input" @bind="Password" placeholder="Password" type="password" />
    <button class="signup-button" @onclick="DoSignUp">Sign Up</button>
</div>

@code {
    string Name = "";
    string Email = "";
    string Password = "";
    string Error = "";

    private async Task DoSignUp()
    {
        Error = "";
        if (string.IsNullOrWhiteSpace(Name) || string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
        {
            Error = "All fields are required";
            return;
        }

        using var connection = new NpgsqlConnection(DbConfig.ConnectionString);
        await connection.OpenAsync();

        using var checkCmd = new NpgsqlCommand("SELECT COUNT(*) FROM users WHERE email=@Email", connection);
        checkCmd.Parameters.AddWithValue("Email", Email);
        var count = Convert.ToInt64(await checkCmd.ExecuteScalarAsync());

        if (count > 0)
        {
            Error = "Email already registered";
            return;
        }

        using var insertCmd = new NpgsqlCommand(
            "INSERT INTO users (name, email, password_hash, created_at) VALUES (@Name,@Email,@PasswordHash,@CreatedAt)",
            connection);
        insertCmd.Parameters.AddWithValue("Name", Name);
        insertCmd.Parameters.AddWithValue("Email", Email);
        insertCmd.Parameters.AddWithValue("PasswordHash", Hash(Password));
        insertCmd.Parameters.AddWithValue("CreatedAt", DateTime.UtcNow);

        await insertCmd.ExecuteNonQueryAsync();

        var authProvider = (SimpleDbAuthProvider)Auth;
        await authProvider.Login(Email, Password);

        NavigationManager.NavigateTo("/");
    }

    private string Hash(string input)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(input);
        var hash = System.Security.Cryptography.SHA256.HashData(bytes);
        return Convert.ToHexString(hash);
    }
}

