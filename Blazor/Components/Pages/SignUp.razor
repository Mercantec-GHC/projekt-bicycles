@page "/signup"
@using Blazor.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Npgsql

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject Blazor.Services.DbConfig DbConfig

<h3>Sign Up</h3>

@if (!string.IsNullOrEmpty(Error))
{
    <div style="color:red">@Error</div>  <!-- Display error messages -->
}

<!-- Input fields bound directly to string variables -->
<input @bind="Name" placeholder="Name" />
<br />
<input @bind="Email" placeholder="Email" type="email" />
<br />
<input @bind="Password" placeholder="Password" type="password" />
<br />
<button @onclick="DoSignUp">Sign Up</button>  <!-- Trigger signup -->

@code {
    string Name = "";     // Stores user-entered name
    string Email = "";    // Stores user-entered email
    string Password = ""; // Stores user-entered password
    string Error = "";    // Stores error messages

    // Sign up logic
    private async Task DoSignUp()
    {
        Error = ""; // Reset error

        // Manual validation
        if (string.IsNullOrWhiteSpace(Name) || string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
        {
            Error = "All fields are required";
            return;
        }

        using var connection = new NpgsqlConnection(DbConfig.ConnectionString);
        await connection.OpenAsync();

        // Check if email already exists
        using var checkCmd = new NpgsqlCommand("SELECT COUNT(*) FROM users WHERE email=@Email", connection);
        checkCmd.Parameters.AddWithValue("Email", Email);
        var result = await checkCmd.ExecuteScalarAsync();// returns object
        var count = Convert.ToInt64(result); // convert to long

        if (count > 0)
        {
            Error = "Email already registered";
            return;
        }

        // Insert new user
        using var insertCmd = new NpgsqlCommand(
            "INSERT INTO users (name, email, password_hash, created_at) VALUES (@Name,@Email,@PasswordHash,@CreatedAt)",
            connection);
        insertCmd.Parameters.AddWithValue("Name", Name);
        insertCmd.Parameters.AddWithValue("Email", Email);
        insertCmd.Parameters.AddWithValue("PasswordHash", Hash(Password));
        insertCmd.Parameters.AddWithValue("CreatedAt", DateTime.UtcNow);

        await insertCmd.ExecuteNonQueryAsync();

        // Log in the new user
        var authProvider = (SimpleDbAuthProvider)Auth;
        await authProvider.Login(Email, Password);

        // Navigate to homepage
        NavigationManager.NavigateTo("/");
    }

    // Hash password with SHA256
    private static string Hash(string input)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(input);
        var hash = System.Security.Cryptography.SHA256.HashData(bytes);
        return Convert.ToHexString(hash); // Convert to hexadecimal string
    }
}
