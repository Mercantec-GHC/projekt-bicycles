@page "/bikes"
@inject BikeService BikeService
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Blazor.Services
@using Blazor.Models

<h3>Bikes</h3>

<div class="filters mb-4">
    <!-- Filter inputs -->
    <select @bind="brandFilter"
            @bind:event="onchange"
            @bind:after="OnBrandFilterChanged"
            class="form-control mb-2">
        <option value="">All Brands</option>
        <option value="Trek">Trek</option>
        <option value="Giant">Giant</option>
        <option value="Specialized">Specialized</option>
        <option value="Cannondale">Cannondale</option>
    </select>

    <select @bind="typeFilter"
            @bind:event="onchange"
            @bind:after="OnTypeFilterChanged"
            class="form-control mb-2">
        <option value="">All Types</option>
        <option value="Mountain">Mountain</option>
        <option value="City">City</option>
        <option value="Electric">Electric</option>
        <option value="Road">Road</option>
    </select>

    <input type="number" placeholder="Max Price"
           @bind="maxPriceFilter" @bind:event="oninput"
           @bind:after="LoadBikes" class="form-control mb-2" />

    <input type="number" placeholder="Model Year"
           @bind="modelYearFilter" @bind:event="oninput"
           @bind:after="LoadBikes" class="form-control mb-2" />

    <input placeholder="Color"
           @bind="colorFilter" @bind:event="oninput"
           @bind:after="LoadBikes" class="form-control mb-2" />

    <input placeholder="Location"
           @bind="locationFilter" @bind:event="oninput"
           @bind:after="LoadBikes" class="form-control mb-2" />

    <select @bind="conditionFilter" @bind:event="onchange"
            @bind:after="LoadBikes" class="form-control mb-2">
        <option value="">All Conditions</option>
        <option value="New">New</option>
        <option value="Used">Used</option>
    </select>
</div>

@if (bikeList is null)
{
    <p>Loading bikes...</p>
}
else if (!bikeList.Any())
{
    <p>No bikes found matching these filters.</p>
}
else
{
    <div class="bikes-container">
        @foreach (var bike in bikeList)
        {
            <SaleCard Bike="bike" />
        }
    </div>
}

@code {
    private List<Bike>? bikeList;

    // Filter properties
    private string brandFilter = string.Empty;
    private string typeFilter = string.Empty;
    private decimal? maxPriceFilter;
    private int? modelYearFilter;
    private string conditionFilter = string.Empty;
    private string colorFilter = string.Empty;
    private string locationFilter = string.Empty;

    // Query parameter bound to the URL
    [Parameter]
    [SupplyParameterFromQuery]
    public string? Type { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Brand { get; set; }

    protected override void OnParametersSet()
    {
        // Update type filter whenever the URL changes (e.g., /bikes?type=Road or /bikes)
        typeFilter = string.IsNullOrWhiteSpace(Type) ? string.Empty : Type.Trim();
        brandFilter = string.IsNullOrWhiteSpace(Brand) ? string.Empty : Brand.Trim();

        LoadBikes();
    }

    private void LoadBikes()
    {
        bikeList = BikeService.GetBikes(
            brandFilter,
            typeFilter,
            colorFilter,
            locationFilter,
            maxPriceFilter,
            modelYearFilter,
            conditionFilter
        );
    }

    // Sync dropdown changes with the URL for better navigation and back/forward support
    private void OnTypeFilterChanged() => UpdateUrl();
    private void OnBrandFilterChanged() => UpdateUrl();
    
    // Update the URL with current filters
    private void UpdateUrl()
    {
        var query = new List<string>();

        // Only add filters that have values
        if (!string.IsNullOrWhiteSpace(typeFilter))
            query.Add($"type={Uri.EscapeDataString(typeFilter)}");

        if (!string.IsNullOrWhiteSpace(brandFilter))
            query.Add($"brand={Uri.EscapeDataString(brandFilter)}");

        // Construct the new URL
        string url;

        // If there are query parameters, append them
        if (query.Any())
            url = "/bikes?" + string.Join("&", query);
        else
            url = "/bikes";

        NavigationManager.NavigateTo(url, replace: false);
    }
}

